# Garbage-First Collector (G1)
## 基本概念
- G1的优点：高throughout、没有fragmentation、垃圾收集时间可控。适合多处理器、大内存的服务器环境
### 分区 Region
G1把堆内存分成大小相等的块，这些块即分区。

分区的类型：
- 自由分区（Free Heap Region, FHR）
- 新生代分区（Young Heap Region, YHR）
- 大对象分区（Humongous Heap Region, HHR）
- 老生代分区（Old Heap Region, OHR）
  
新生代分区又可以分为：
- Eden （1个）
- Survivor (2个)

#### 分区大小的设置
1. 🍐 XX:G1HeapRegionSize=n指定，n为2的幂，范围1-32MB，参数默认值为0
2. 在不使用上面参数指定时，启发式推断

#### 新生代大小设置
新生代大小指所有新生代分区的内存的总和。由于G1中的堆内存使用分区组织，所以设置新生代的大小也就是在设置新生代分区的数量，也就是先计算整个新生代的内存总和，再计算分区大小，最后$(总和/分区大小)$得到新生代分区的数量。

新生代分区大小设置的逻辑：
1. 设置MaxNewSize(新生代最大值)和NewSize(新生代最小值)。G1使用这些值动态调整新生代分区。
   > 注意设置Xmn(新生代大小)，等价于MaxNewSize=NewSize，这时对于G1来说，G1不能调整新生代分区的大小，那么GC可能不能满足停顿时间要求。
2. 只设置了MaxNewSize或NewSize，且设置了NewRatio，忽略NewRatio
3. 只设置了NewRatio，那么新生代的最大值和最小值是相同的，都是$(整个堆空间大小/(NewRatio + 1))$
4. 如果新生代最大、最小值都没有设置，或者只设置了其中的一个，那么G1根据G1MaxNewSizePercent(默认60)和G1NewSizePercent(默认5)占整个堆空间的比例来计算新生代的最大值和最小值。

#### 新生代分区的扩张
如果G1是启发式推断新生代的大小，那么新生代大小变化的逻辑如下：
1. 使用一个分区列表，扩张时如果有空闲的分区列表，则直接把空闲的分区加入到新生代分区列表里
2. 如果没有空闲分区，那么分配新的分区，然后把新生成的分区加入到新生代分区列表里。

分配新分区的方式如下：
TODO: 


### 卡表和位图



